{% extends "core/base.html" %}

{% block title %}Home{% endblock title %}
{% block content %}
    
 <h2> Welcome Foodies </h2>
              
 {% endblock content %}
{% block body %}
{% load static %}
<!-- Events Section -->
    <section id="events" class="events section">

      <div class="container" data-aos="fade-up" data-aos-delay="100">

        <div class="intro-text text-center mb-5" data-aos="fade-up" data-aos-delay="150">
          <h2>Create Unforgettable Moments</h2>

          
        </div>
{% comment %} render the products from the database {% endcomment %}
        {% for product , range , nslides in allproducts %}
        
        <div class="container">
          <h3 class="my-3 text-center">{{product.0.category}}</h3>
        </div>
        <div class="container">
          <div class="row">

            {% for i in product %}
            
            <div class="col-md-3 mt-3">
              {% comment %} {{i.images.url}} {% endcomment %}
              <img src='/media/{{i.image}}' class="card-img-top" alt="not found" height="200px" width="200px" >
                <div class="card-body">
                  <h5 class="card-title mt-4" id="namepr{{i.id}}">{{i.product_name}}</h5>
                  <p class="card-text">{{i.desc|slice:"0.50"}}...</p>
                  <h6 class="card-title mb-3">Price: Rs<span id="pricepr{{i.id}}">{{i.price}}</span></h6>
                  <span id="divpr{{i.id}}" class="divpr">

                    <button id="pr{{i.id}}" class="btn btn-success btn-sm mt-0 cart">Add to cart</button>
                    
                  </span>
                  
                  <a href="/media/{{i.image}}">
                    <button class="btn btn-dark btn-sm cart">View</button>
                  </a>
                </div>
            </div>            
            
            
            {% endfor %}




          </div>

        </div>


        
        
        {% endfor %}

      </div>

    </section><!-- /Events Section -->

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js" integrity="sha384-G/EV+4j2dNv+tEPo3++6LCgdCROaejBqfUeNjuKAiuXbjrxilcCdDz6ZAVfHWe1Y" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

<script>
  // ================= CART INITIALIZATION =================
  var cart = {};
  
  {% if user.is_authenticated %}
  // Initialize cart from localStorage for authenticated users
  if (localStorage.getItem('cart') == null) {
    cart = {};
  } else {
    try {
      cart = JSON.parse(localStorage.getItem('cart'));
      // Validate cart structure
      if (typeof cart !== 'object' || cart === null) {
        cart = {};
      }
    } catch (e) {
      console.error('Error parsing cart from localStorage:', e);
      cart = {};
    }
  }
  {% else %}
  // Clear cart for non-authenticated users
  cart = {};
  localStorage.removeItem('cart');
  var cartElement = document.getElementById('cart');
  if (cartElement) {
    cartElement.innerHTML = '0';
  }
  {% endif %}

  // Initialize cart display on page load
  $(document).ready(function() {
    {% if user.is_authenticated %}
    if (Object.keys(cart).length > 0) {
      updateCart(cart);
    }
    // Initialize Bootstrap popover for cart
    initializeCartPopover();
    {% endif %}
  });

  // ================= INITIALIZE CART POPOVER =================
  function initializeCartPopover() {
    var cartButton = document.querySelector('button[data-bs-toggle="popover"]');
    if (cartButton && typeof bootstrap !== 'undefined') {
      var popover = new bootstrap.Popover(cartButton, {
        html: true,
        placement: 'bottom',
        trigger: 'click'
      });
      // Store popover reference globally for updates
      window.cartPopover = popover;
      // Update popover content
      updatePopover(cart);
    }
  }

  // ================= ADD TO CART =================
  $(document).on('click', '.divpr button.cart', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    {% if not user.is_authenticated %}
    // Redirect to login if not authenticated
    if (confirm('You need to login to add items to cart. Would you like to login now?')) {
      window.location.href = '/auth/login/?next=' + encodeURIComponent(window.location.pathname);
    }
    return false;
    {% endif %}
    
    var idstr = this.id;
    
    // Validate that the element exists
    if (!idstr || idstr === '') {
      console.error('Invalid product ID');
      return false;
    }

    // Get product details
    var nameElement = document.getElementById('name' + idstr);
    var priceElement = document.getElementById('price' + idstr);
    
    if (!nameElement || !priceElement) {
      console.error('Product details not found for ID:', idstr);
      return false;
    }

    var name = nameElement.innerHTML.trim();
    var price = priceElement.innerHTML.trim();

    // Add or update item in cart
    if (cart[idstr] != undefined) {
      cart[idstr][0] += 1; // Increment quantity
    } else {
      cart[idstr] = [1, name, price]; // Add new item
    }

    updateCart(cart);
    
    // Show feedback
    var btn = $(this);
    var originalText = btn.html();
    btn.html('<i class="bi bi-check"></i> Added').addClass('btn-success');
    setTimeout(function() {
      btn.html(originalText);
    }, 1000);
  });

  // ================= UPDATE CART =================
  function updateCart(cart) {
    {% if not user.is_authenticated %}
    // Don't allow cart updates for non-authenticated users
    cart = {};
    localStorage.removeItem('cart');
    var cartElement = document.getElementById('cart');
    if (cartElement) {
      cartElement.innerHTML = '0';
    }
    return;
    {% endif %}
    
    var sum = 0;
    var cartCount = 0;

    // Update UI for each item in cart
    for (var item in cart) {
      if (cart.hasOwnProperty(item)) {
        var quantity = cart[item][0];
        sum += quantity;
        cartCount += quantity;

        // Update the product div with quantity controls
        var divElement = document.getElementById('div' + item);
        if (divElement) {
          divElement.innerHTML =
            "<button id='minus" + item + "' class='btn btn-success minus btn-sm' title='Decrease quantity'>-</button> " +
            "<span id='val" + item + "' class='mx-2 fw-bold'>" + quantity + "</span> " +
            "<button id='plus" + item + "' class='btn btn-success plus btn-sm' title='Increase quantity'>+</button>";
        }
      }
    }

    // Update items not in cart to show "Add to cart" button
    var allDivs = document.querySelectorAll('.divpr');
    allDivs.forEach(function(div) {
      var divId = div.id;
      if (divId && divId.startsWith('divpr')) {
        var itemId = divId.replace('div', '');
        if (!cart[itemId] || cart[itemId] === undefined) {
          var buttonId = itemId.replace('div', '');
          div.innerHTML = "<button id='" + buttonId + "' class='btn btn-success btn-sm mt-0 cart'>Add to cart</button>";
        }
      }
    });

    // Save to localStorage
    try {
      localStorage.setItem('cart', JSON.stringify(cart));
    } catch (e) {
      console.error('Error saving cart to localStorage:', e);
    }

    // Update cart count display
    var cartElement = document.getElementById('cart');
    if (cartElement) {
      cartElement.innerHTML = cartCount;
    }

    // Update popover
    updatePopover(cart);
  }

  // ================= UPDATE POPOVER =================
  function updatePopover(cart) {
    var popStr = "";
    
    {% if not user.is_authenticated %}
    popStr = "<h5 class='mb-3'>Your Cart</h5><div class='mx-2 my-2'><p class='text-warning mb-2'>Please <a href='/auth/login/'>login</a> to add items to cart and checkout.</p></div>";
    {% else %}
    var itemCount = Object.keys(cart).length;
    
    if (itemCount === 0) {
      popStr = "<h5 class='mb-3'>Your Cart</h5><div class='mx-2 my-2'><p class='text-muted'>Your cart is empty.</p></div>";
    } else {
      popStr = "<h5 class='mb-3'>Your Cart</h5><div class='mx-2 my-2'><div class='cart-items'>";
      var i = 1;
      var totalPrice = 0;

      for (var item in cart) {
        if (cart.hasOwnProperty(item)) {
          var quantity = cart[item][0];
          var name = cart[item][1];
          var price = parseFloat(cart[item][2].replace(/[^0-9.]/g, '')) || 0;
          var itemTotal = price * quantity;
          totalPrice += itemTotal;

          popStr += "<div class='cart-item mb-2 pb-2 border-bottom'>";
          popStr += "<div class='d-flex justify-content-between align-items-start'>";
          popStr += "<div class='flex-grow-1'>";
          popStr += "<b>" + i + ".</b> " + name.slice(0, 25) + (name.length > 25 ? "..." : "") + "<br>";
          popStr += "<small class='text-muted'>Qty: <b>" + quantity + "</b> Ã— Rs " + price.toFixed(2) + "</small>";
          popStr += "</div>";
          popStr += "<div class='text-end'><strong>Rs " + itemTotal.toFixed(2) + "</strong></div>";
          popStr += "</div></div>";
          i++;
        }
      }

      popStr += "</div>";
      popStr += "<div class='mt-3 pt-2 border-top'><div class='d-flex justify-content-between mb-2'><strong>Total:</strong><strong>Rs " + totalPrice.toFixed(2) + "</strong></div></div>";
      popStr += "<div class='mt-3 d-flex gap-2'>";
      popStr += "<a href='/checkout' class='btn btn-success btn-sm flex-fill'>Checkout</a>";
      popStr += "<button class='btn btn-dark btn-sm' onclick='clearCart()'>Clear Cart</button>";
      popStr += "</div></div>";
    }
    {% endif %}

    // Update Bootstrap popover
    var cartButton = document.querySelector('button[data-bs-toggle="popover"]');
    if (cartButton) {
      if (window.cartPopover) {
        // Update existing popover
        cartButton.setAttribute('data-bs-content', popStr);
        window.cartPopover.setContent({ '.popover-body': popStr });
      } else {
        // Set content attribute for initialization
        cartButton.setAttribute('data-bs-content', popStr);
      }
    }
  }

  // ================= CLEAR CART =================
  function clearCart() {
    if (confirm('Are you sure you want to clear your cart?')) {
      cart = {};
      localStorage.removeItem('cart');
      
      // Reset all product divs to show "Add to cart" button
      var allDivs = document.querySelectorAll('.divpr');
      allDivs.forEach(function(div) {
        var divId = div.id;
        if (divId && divId.startsWith('divpr')) {
          var itemId = divId.replace('div', '');
          div.innerHTML = "<button id='" + itemId + "' class='btn btn-success btn-sm mt-0 cart'>Add to cart</button>";
        }
      });
      
      // Update cart count
      var cartElement = document.getElementById('cart');
      if (cartElement) {
        cartElement.innerHTML = '0';
      }
      
      // Update popover
      updatePopover(cart);
      
      // Hide popover if open
      if (window.cartPopover) {
        window.cartPopover.hide();
      }
    }
  }

  // ================= DECREASE QUANTITY (MINUS) =================
  $(document).on('click', '.divpr button.minus', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    {% if not user.is_authenticated %}
    if (confirm('You need to login to manage your cart. Would you like to login now?')) {
      window.location.href = '/auth/login/?next=' + encodeURIComponent(window.location.pathname);
    }
    return false;
    {% endif %}
    
    var idstr = this.id.replace('minus', '');
    
    if (cart[idstr] != undefined) {
      if (cart[idstr][0] > 1) {
        cart[idstr][0] -= 1; // Decrease quantity
      } else {
        // Remove item if quantity would be 0
        delete cart[idstr];
        // Reset the div to show "Add to cart" button
        var divElement = document.getElementById('div' + idstr);
        if (divElement) {
          divElement.innerHTML = "<button id='" + idstr + "' class='btn btn-success btn-sm mt-0 cart'>Add to cart</button>";
        }
      }
      updateCart(cart);
    }
  });

  // ================= INCREASE QUANTITY (PLUS) =================
  $(document).on('click', '.divpr button.plus', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    {% if not user.is_authenticated %}
    if (confirm('You need to login to manage your cart. Would you like to login now?')) {
      window.location.href = '/auth/login/?next=' + encodeURIComponent(window.location.pathname);
    }
    return false;
    {% endif %}
    
    var idstr = this.id.replace('plus', '');
    
    if (cart[idstr] != undefined) {
      cart[idstr][0] += 1; // Increase quantity
      updateCart(cart);
    }
  });

  // ================= HANDLE PAGE VISIBILITY (Update cart when tab becomes visible) =================
  document.addEventListener('visibilitychange', function() {
    if (!document.hidden && {% if user.is_authenticated %}true{% else %}false{% endif %}) {
      // Reload cart from localStorage when page becomes visible
      try {
        var storedCart = localStorage.getItem('cart');
        if (storedCart) {
          var parsedCart = JSON.parse(storedCart);
          if (parsedCart && typeof parsedCart === 'object') {
            cart = parsedCart;
            updateCart(cart);
          }
        }
      } catch (e) {
        console.error('Error reloading cart:', e);
      }
    }
  });


</script>

{% endblock body%}


